# 转换器

由于转换器非常多，因此仅对部分需要重点讲解的部分进行说明。


## let和set
let不修改列，但负责指定目标列，通过let算子，可指定要处理的列,例如:

`task().create(datas).let('a').strip().format('{}{}')`

让a属性的值，去除空白符，并将其值重复两次。对多个列可批量处理，中间用空格分割。如`a b c`

- let('*') 表示对所有的列做处理
- 参数可以写正则表达式，能成功匹配的列都能做处理。

如果只有一个列，且列名符合python命名规则，则let函数可以省略，上面的代码能简化为:

`task().create(datas).a.strip().format('{}{}').b....`

set算子可以对固定列设置值，例如：

`p.set('value')`

set算子还能将别的列的值填充到目标列，上面的等价为：

`a.set('value').p.set('[value]')`



## 目标列转换器

cp,cp2,mv,rm,keep 的功能可参考算子表，此处从略。`keep('a')`会删除除了a列以外的所有列。

如果需要对多个列进行批量处理，列名可以用空格分割：`mv('a b c')`

cp,cp2需要接受多个键值对，例如从a列拷贝到b列，c列拷贝到d列，则可以写作:
`cp('a:b c:d')`

对a列保留，并将c列移动到d列，有两种写法:
`keep('a c').mv('c:d')` 或:
`keep('a c:d)`

> 注意cp和cp2的区别，cp拷贝后做滑动，cp2不做滑动。cp2等价于cp('a:b').let('a'), mv,cp,rm的命名都参考了linux的风格


## at

对目标列数据取索引值，并放置在本列位置。使用方法和python的字典和数组的索引使用方法一致。at可以省略，例如：

`create(datas).p.at(0).at('hello')`

等价于：

`create(datas).p[0]['hello]`

at还支持输入slice:

`create(datas).p[2:10]`

很多算子的结果都是数组，字典或生成器，都可以用at算子将其数据提出。对生成器，则输出第n个元素。

> 对生成器，慎用类似`-1`的倒序索引，这可能会导致实例化生成器，从而导致性能问题。

## 字符串分割

由于etl中会出现大量字符串分割的需求，因此提供了split和into算子，以及at算子

split会将字符串分割为数组，如a列值为'1 2 3'，若想放置到a,b,c三列，则:

`a.split(' ').cp('a:b')[1].cp('a:c)[2].a[0]`

上面的代码也等价于:

`a.split(' ').into('a b c')`


## 字符串转义,加载

escape代表对字符串转义，clean则代表反转义。从网页中常见nbsp等，其实是空格，则可以：

`a.clean('html')`

带代表使用html反转义功能，若想对url编码，则可以:

`a.escape('url')`

类似的还有load和dump，如加载a列中文本形式的json文件，并将其转换为xml

`a.load('json').dump('xml)`

目前load/dump支持 xml,json,yaml这几种类型

## 正则表达式

正则可以方便地提取文本的内容，etlpy支持对流进行匹配和过滤。涉及的算子有re,num 

re可将内部的匹配结果以数组输出，例如 a='123 345 678',需要将内部的字符串提取出来:

`a.re('\d+')[0]  #a列放置123`

num是re的特例，用于提取浮点数和整数。

## 上钻下探

### list 

当目标列中放置着一个字典数组/字典生成器)时，一个可能的需求是将其提取并代替外部的流。list可以作为一转多的算子实现该功能， 例如:

`task().p.create(('a':i for i in range(10))).list()`

其等价于：
`task().a.create(range(1,10))`

注意，在一转多之后，原始流的列会被丢弃，如果不想丢弃，可以在list的参数中传递列表达式, 如`list('p:p1 p2')`会将p列保存在新流的p1列，p2列保存在新流的p2列。语法与cp,keep一致。


### drill和todict

类似地，目标列如果是字典（注意，不是字典的数组），需要将其合并到外部，需要用drill算子。

`p.set({'a':1,'b':2}).drill()` 等价于:

`p.a.set(1).b.set('2')`

若drill没有参数，则默认转换所有的列。drill也支持参数，语法和list一致。

如果希望把多个列的数据合并到目标列，并保存到字典中，则使用todict,例如:

`a.set(1).b.set(2).p.todict('a b')` 

todict经常用于向网站post字典数据等。


## 字符串处理

strip和python标准的strip用法类似。

extract可以通过首位字符提取字符串，特别适合用于在复杂文本中抽取数据。例如p列保存为：'abc 123 def',要提取123，则

`a.extract('abc',end='def')`

默认参数为start字符串, end填写要结尾的字符串，提取的内容为两个字符串中间的部分。

format可以将多个列合并到一列，用法与python标准的format一致，例如将p列改造为url:

`p.set(1).format('www.abc.com/p{}')`  #输出 www.abc.com/p1

也可以合并多个列:

`p.set(1).q.set(2).format('{[p]}:{[q]}')`  #输出 1-2


## 流处理

take,skip能对流做裁剪，例如:

`p.create(range(1,10)).skip(3).take(2)`

输出: {'p':3}, {'p':4}

last能获取流的最后一个元素

`p.create(range(1,10)).last()`

输出: {'p':9}

## 调试和输出

具体用法可参考调试和输出章节，以下标签都可以在流代码的任何位置插入：

tag标签，其功能仅仅用于显示代码功能：

`p.tag('这里输出注释').list()...`

count标签，用于每输出p个元素，就会输出一次位置

`p.range(100).count(20)`

输出： 20,40,60....


















