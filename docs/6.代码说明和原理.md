# 代码分析和原理

etlpy的源代码非常简洁，只有三个py文件，核心etl.py只有1500行。

## 核心代码

etlpy的解释器会分析链式语法，并构建相应的计算图。 但只有真实迭代时，才会进行求值。

generate函数，会将多个tool拼接，组合成高阶函数，其实现如下：
```
def generate(tools, generator=None, env=None):
    '''
    evaluate a tool stream
    :param tools: [ETLTool]
    :param generator: seed generator for generator
    :param init: bool, if initiate every tool
    :param execute: bool, if enable executors
    :param env:
    :return: a generator
    '''
    if env is None:
        env = {'column': ''}
    if tools is not None:
        for tool in tools:
            env= get_column(tool,env)
            if isinstance(tool,LetTF):
                continue
            column= env['column']
            generator = tool.process(generator, column) #核心部分
            env['column']=env['next']
    if generator is None:
        return []
    return generator
```

对每个tool进行遍历，在核心部分被组合成新的迭代器。环境会在构建函数时被传递和修改（目前环境仅维护了列名）

